# GROUP BY と集約関数の論理実行イメージ

## 対象 SQL

```sql
SELECT dept_id, AVG(salary) AS avg_salary
FROM employee
WHERE salary > 300000
GROUP BY dept_id
HAVING AVG(salary) > 400000
ORDER BY avg_salary DESC;
```

## 論理実行順（SQL 標準に準拠した概念的な順序）

| ステップ | 句           | 処理内容                                         | テーブル状態イメージ                              |
| -------- | ------------ | ------------------------------------------------ | ------------------------------------------------- |
| ①        | **FROM**     | 対象テーブルを読み込み                           | employee（全行）                                  |
| ②        | **WHERE**    | 各行に条件を適用し、**行**を絞り込み             | salary > 300000 の行のみ残る                      |
| ③        | **GROUP BY** | group by キー ごとに行をグループ化               | グループごとに `{dept_id, salary一覧}` が束になる |
| ④        | **HAVING**   | 各グループに条件を適用し、**グループ**を絞り込み | `AVG(salary) > 400000` のグループだけ残る         |
| ⑤        | **SELECT**   | グループから表示列を作成（キーと集計結果など）   | `{dept_id, avg_salary}` の中間テーブル生成        |
| ⑥        | **ORDER BY** | 最終出力を並び替え                               | avg_salary の降順にソートされた出力               |

---

## テーブル状態イメージ

### ① FROM

```SQL
FROM employee
```

| emp_id | dept_id | salary |
| ------ | ------- | ------ |
| 1      | 10      | 500000 |
| 2      | 10      | 400000 |
| 3      | 20      | 600000 |
| 4      | 20      | 200000 |
| 5      | 30      | 300000 |

---

### ② WHERE

```SQL
WHERE salary > 300000
```

| emp_id | dept_id | salary |            |
| ------ | ------- | ------ | ---------- |
| 1      | 10      | 500000 | ✅         |
| 2      | 10      | 400000 | ✅         |
| 3      | 20      | 600000 | ✅         |
| 4      | 20      | 200000 | ❌（除外） |
| 5      | 30      | 300000 | ✅         |

⇒ 適用後

| emp_id | dept_id | salary |
| ------ | ------- | ------ |
| 1      | 10      | 500000 |
| 2      | 10      | 400000 |
| 3      | 20      | 600000 |
| 5      | 30      | 300000 |

---

### ③ GROUP BY

```SQL
GROUP BY dept_id
```

dept_id ごとにグループ化（この時点で「まとめられた行の集合」ができる）

| emp_id 集合 | dept_id | salary 集合      |
| ----------- | ------- | ---------------- |
| {1,2}       | 10      | {500000, 400000} |
| {3}         | 20      | {600000}         |
| {5}         | 30      | {300000}         |

---

### ④ HAVING

```SQL
HAVING AVG(salary) > 400000
```

`AVG(salary) > 400000` のグループだけ残す

| emp_id 集合 | dept_id | salary 集合      |                    |
| ----------- | ------- | ---------------- | ------------------ |
| {1,2}       | 10      | {500000, 400000} | 450000 ✅          |
| {3}         | 20      | {600000}         | 600000 ✅          |
| {5}         | 30      | {300000}         | 300000 ❌ （除外） |

⇒ 適用後

| emp_id 集合 | dept_id | salary 集合      |
| ----------- | ------- | ---------------- |
| {1,2}       | 10      | {500000, 400000} |
| {3}         | 20      | {600000}         |

---

### ⑤ SELECT

```SQL
SELECT dept_id, AVG(salary) AS avg_salary
```

HAVING 後のグループから選択列を生成
<font color="red">※ここで salary を表示したい時、集計関数を使って salary の代表値を決めないと、集合の中のどれを表示したらいいか困ってしまう</font>

| emp_id 集合 | dept_id | salary 集合      |
| ----------- | ------- | ---------------- |
| {1,2}       | 10      | {500000, 400000} |
| {3}         | 20      | {600000}         |

⇒ 適用後

| dept_id | avg_salary |
| ------- | ---------- |
| 10      | 450000     |
| 20      | 600000     |

---

### ⑥ ORDER BY

```SQL
ORDER BY avg_salary DESC
```

avg_salary 降順に並べ替え

| dept_id | avg_salary |
| ------- | ---------- |
| 20      | 600000     |
| 10      | 450000     |

---

## 注意点：この論理モデルでカバーできない点

1. **物理的な実行順は必ずしもこの通りではない**

   - 実際の DB エンジンは、WHERE → GROUP BY → HAVING → SELECT → ORDER BY
     の順に**論理的に**動作しますが、内部では最適化により
     集計とフィルタが同時処理されることがあります。
   - 例：`HAVING AVG(salary) > 400000` を実行前に
     一部推測してスキップする（クエリプラン最適化）。

2. **グループ化後の「一時テーブル」は概念的なもの**

   - 実際にはハッシュやソートベースの集約アルゴリズムが使われ、
     中間テーブルが物理的に存在するとは限りません。

3. **SELECT 句の評価は内部的に遅延される**

   - 多くの実装では、`GROUP BY` や `HAVING` が完了した後に
     SELECT が評価されますが、パイプライン処理で並行的に動くこともあります。

---

### 理解度チェック

```SQL
SELECT
	CATEGORY,
	COUNT(*) AS PRODUCT_COUNT
FROM
	PRODUCTS_MST
WHERE
	STOCK_QUANTITY >= 100
GROUP BY
	CATEGORY
HAVING
	COUNT(*) >= 2;
```

<details>
<summary>答え</summary>

</details>
