# EC サイトのデータ分析：第 1 週 基礎編

全 20 日

- レベル
  - レベル 1：基礎構文 ⇒13/20 件（1 週目（4 日））
  - レベル 2：集計とグループ化 ⇒5/15 件（2 週目前半（3 日））
    - INNER JOIN
    - LEFT JOIN / RIGHT JOIN
    - FULL OUTER JOIN
    - 自己結合
    - on と where で条件を書くのはどう違うか
  - レベル 3：複数テーブル操作 ⇒2/20 件（2 週目後半～ 3 週目（4 日））
    - UNION, UNION ALL
  - レベル 3：複数テーブル操作 ⇒2/20 件（2 週目後半～ 3 週目（4 日））
    - 非相関サブクエリ
    - 相関サブクエリ
    - EXISTS / NOT EXISTS
  - レベル 4：高度な SELECT⇒0/10 件（3 週目の最後～ 4 週目前半（2 日））
    - ウィンドウ関数
    - CTE（共通テーブル式）
  - レベル 5：総合問題（復習になりそう） ⇒0/15 件（3 日）
    - 複雑な INSERT/UPDATE
      - INSERT ... SELECT
      - UPDATE ... JOIN
      - MERGE（UPSERT）
  - その他
    - 実行計画

1. テーブル作成と初期データ投入
   研修を開始する前に、以下の SQL を実行してデータベース環境を準備してください。

SQL

```SQL
-- テーブル作成
CREATE TABLE customers_mst (
    customer_id VARCHAR(50) PRIMARY KEY,
    customer_name VARCHAR(100) NOT NULL,
    email VARCHAR(255) UNIQUE,
    created_date DATE NOT NULL
);

CREATE TABLE products_mst (
    product_id VARCHAR(50) PRIMARY KEY,
    product_name VARCHAR(255) NOT NULL,
    price DECIMAL(10, 2) NOT NULL,
    stock_quantity INT NOT NULL CHECK (stock_quantity >= 0)
);

CREATE TABLE orders_trn (
    order_id VARCHAR(50) PRIMARY KEY,
    customer_id VARCHAR(50) REFERENCES customers_mst(customer_id),
    order_date DATE NOT NULL
);

CREATE TABLE order_details_trn (
    order_detail_id SERIAL PRIMARY KEY,
    order_id VARCHAR(50) REFERENCES orders_trn(order_id),
    product_id VARCHAR(50) REFERENCES products_mst(product_id),
    quantity INT NOT NULL CHECK (quantity > 0)
);

-- 初期データ投入
INSERT INTO customers_mst (customer_id, customer_name, email, created_date) VALUES
('C001', '田中一郎', 'ichiro.tanaka@example.com', '2024-01-15'),
('C002', '佐藤二郎', 'jiro.sato@example.com', '2024-02-20'),
('C003', '高橋三郎', 'saburo.takahashi@example.com', '2024-03-10');

INSERT INTO products_mst (product_id, product_name, price, stock_quantity) VALUES
('P001', 'ゲーミングマウス', 5000.00, 150),
('P002', 'メカニカルキーボード', 15000.00, 80),
('P003', 'ウェブカメラ', 8000.00, 30),
('P004', 'モニターアーム', 6500.00, 250),
('P005', 'マイクスタンド', 3000.00, 45);

INSERT INTO orders_trn (order_id, customer_id, order_date) VALUES
('O001', 'C001', '2024-04-01'),
('O002', 'C002', '2024-04-02'),
('O003', 'C001', '2024-04-03'),
('O004', 'C003', '2024-04-04');

INSERT INTO order_details_trn (order_id, product_id, quantity) VALUES
('O001', 'P001', 1),
('O002', 'P002', 1),
('O003', 'P001', 2),
('O003', 'P004', 1),
('O004', 'P003', 1);
```

2. 問題と解答

---

##### ★select レベル 1

問題 1：商品情報の取得
学習目的: SELECT 文と FROM 句の基本的な使い方を習得し、テーブル内のすべてのカラム行を取得する。

問題: products_mst テーブルから、全ての商品情報（商品 ID、商品名、価格、在庫数）を取得してください。

答え:

```SQL
SELECT
product_id,
product_name,
price,
stock_quantity
FROM
products_mst;
```

---

##### ★select レベル 1

問題 2：特定商品の価格検索
学習目的: WHERE 句を使用して、特定の条件に合致するデータのみを抽出する。

問題: products_mst テーブルから、商品 ID が P003 の商品の価格を検索してください。

答え:

```SQL
SELECT
price
FROM
products_mst
WHERE
product_id = 'P003';
```

---

##### ★select レベル 1

問題 3：在庫数が少ない商品の特定
学習目的: WHERE 句で比較演算子（<）を使って数値の条件を指定する。

問題: products_mst テーブルから、在庫数が 50 個以下 の商品を抽出し、商品名と在庫数を表示してください。

答え:

```SQL
SELECT
product_name,
stock_quantity
FROM
products_mst
WHERE
stock_quantity <= 50;
```

---

##### ★select レベル 1

問題 4：高価格商品の検索
学習目的: WHERE 句で AND や OR といった論理演算子を組み合わせて、複数の条件を指定する。

問題: products_mst テーブルから、価格が 8,000 円以上 かつ、在庫数が 100 個以下 の商品をすべて取得してください。

答え:

```SQL

SELECT \*
FROM
products_mst
WHERE
price >= 8000 AND stock_quantity <= 100;

```

---

##### ★insert レベル 1

問題 5：新規顧客の登録
学習目的: INSERT 文を使用して、テーブルに新しい行を追加する。

問題: customers_mst テーブルに、新しい顧客情報を登録してください。

顧客 ID: C101
氏名: 鈴木花子
メールアドレス: hanako.suzuki@example.com
登録日: 2024-08-17

答え:

```SQL
INSERT INTO customers_mst (customer_id, customer_name, email, created_date)
VALUES ('C101', '鈴木花子', 'hanako.suzuki@example.com', '2024-08-17');
```

---

##### ★insert レベル 1

INSERT （複数行の追加）

学習目的: 複数のレコードを一度の INSERT 文で追加する効率的な方法を学ぶ。

問題: products_mst テーブルに、以下の 2 つの新商品をまとめて登録してください。

商品 ID 商品名 価格 在庫数
P006 ノイズキャンセリングヘッドホン 25000.00 120
P007 モバイルバッテリー 4500.00 300

答え:

```SQL
INSERT INTO products_mst (product_id, product_name, price, stock_quantity) VALUES
('P006', 'ノイズキャンセリングヘッドホン', 25000.00, 120),
('P007', 'モバイルバッテリー', 4500.00, 300);
```

---

##### ★update レベル 1

問題 6：商品価格の更新
学習目的: UPDATE 文を使用して、既存のデータの特定のカラムの値を変更する。WHERE 句で更新対象を絞り込むことの重要性を学ぶ。

問題: products_mst テーブルにある、商品 ID が P005 の商品の価格を 8,500 円 に更新してください。

答え:

```SQL
UPDATE
products_mst
SET
price = 8500.00
WHERE
product_id = 'P005';
```

---

##### ★update レベル 1

問題 7：商品在庫の更新
学習目的: UPDATE 文で既存の値を基に計算を行う。

問題: 商品 ID が P001 の商品が 30 個 売れたと想定し、products_mst テーブルの在庫数を更新してください。

答え:

```SQL
UPDATE
products_mst
SET
stock_quantity = stock_quantity - 30
WHERE
product_id = 'P001';
```

---

##### ★update レベル 1

UPDATE （複数行の更新）

学習目的: WHERE 句で複数のレコードを対象に一括でデータを更新する方法を学ぶ。
問題: 在庫数が 100 個以下の商品について、価格を 10%値上げしてください。

答え:

```SQL
UPDATE
products_mst
SET
price = price \* 1.10
WHERE
stock_quantity <= 100;
```

---

##### ★delete レベル 1

問題 8：テストデータの削除
学習目的: DELETE 文を使用して、テーブルから特定の行を削除する。WHERE 句を省略した場合の影響を理解する。

問題: customers_mst テーブルから、登録日が 2024-08-17 のテスト顧客データを削除してください。

答え:

```SQL
DELETE FROM
customers_mst
WHERE
created_date = '2024-08-17';
```

---

### TODO

論理削除の問題を作る

---

##### ★select レベル 1

日付・時間関数
問題 13：注文日の年と月を抽出

学習目的: EXTRACT()や TO_CHAR()などの関数を使って、日付データから特定の単位（年、月など）を抽出する。

問題: orders_trn テーブルの全ての注文について、注文日と、その注文日の年と月をそれぞれ抽出して表示してください。

答え:

```SQL
SELECT
    order_date,
    EXTRACT(YEAR FROM order_date) AS order_year,
    EXTRACT(MONTH FROM order_date) AS order_month
FROM
    orders_trn;

-- 別解（TO_CHAR()関数を使用）
SELECT
    order_date,
    TO_CHAR(order_date, 'YYYY') AS order_year,
    TO_CHAR(order_date, 'MM') AS order_month
FROM
    orders_trn;
```

---

##### ★select レベル 1

文字列関数
問題 14：メールアドレスのドメイン抽出

学習目的: SUBSTRING()や SPLIT_PART()などの関数を使って、文字列から特定の部分を抽出する。

問題: customers_mst テーブルの顧客について、メールアドレスから**ドメイン部分（@以降の部分）**を抽出して表示してください。

答え:

```SQL

SELECT
    customer_name,
    SUBSTRING(email FROM POSITION('@' IN email) + 1) AS email_domain
FROM
    customers_mst;

-- 別解（SPLIT_PART()関数を使用）
SELECT
    customer_name,
    SPLIT_PART(email, '@', 2) AS email_domain
FROM
    customers_mst;

```

---

##### ★select レベル 1

データ型のキャスト
問題 16：価格を文字列として表示

学習目的: CAST()関数や::演算子を使って、あるデータ型を別のデータ型に変換する。

問題: products_mst テーブルから、各商品の価格を**'円'**という文字と連結して表示してください。価格は数値型のため、文字列型に変換する必要があります。

答え:

```SQL

SELECT
    product_name,
    CAST(price AS VARCHAR) || '円' AS price_with_currency
FROM
    products_mst;

-- 別解（::演算子を使用）
SELECT
    product_name,
    price::VARCHAR || '円' AS price_with_currency
FROM
    products_mst;
```

---

##### ★select レベル 2

NULL の扱い
問題 15：NULL 値の置換

学習目的: COALESCE()や CASE などの関数を使って、NULL 値を別の値に置き換える。

問題: customers_mst テーブルの email カラムに NULL 値が含まれていると想定し、NULL の場合に**'メールアドレス未登録'**と表示してください。

答え:

```SQL

-- 仮にemailがNULLのデータとして、以下のUPDATEを実行してからSELECTすると効果がわかる
-- UPDATE customers_mst SET email = NULL WHERE customer_id = 'C002';

SELECT
    customer_name,
    COALESCE(email, 'メールアドレス未登録') AS email_with_default
FROM
    customers_mst;

-- 別解（CASE文を使用）
SELECT
    customer_name,
    CASE
        WHEN email IS NULL THEN 'メールアドレス未登録'
        ELSE email
    END AS email_with_default
FROM
    customers_mst;

```

---

##### ★select レベル 2

問題 9：全商品の在庫合計
学習目的: SUM()集計関数を使用して、数値データの合計を計算する。

問題: products_mst テーブルに登録されている、全ての商品在庫数の合計を計算してください。

答え:

```SQL
SELECT
SUM(stock_quantity)
FROM
products_mst;
```

---

##### ★select レベル 2

問題 10：注文された商品の種類数
学習目的: COUNT()集計関数と DISTINCT 句を組み合わせて、重複を除いたユニークな件数を数える。

問題: order_details_trn テーブルを使って、これまでに注文された商品の種類数を数えてください。

答え:

```SQL
SELECT
COUNT(DISTINCT product_id)
FROM
order_details_trn;
```

---

##### ★select レベル 2

SELECT (LIKE / LIMIT / ORDER BY)

学習目的: 部分一致検索（LIKE）や、取得件数の制限（LIMIT）を組み合わせて、より柔軟なデータ検索を行う。

問題: 商品名に**「マウス」または「キーボード」を含む商品について、価格が高い順に上位 3 件**のみを抽出してください。

答え:

```SQL
SELECT
product_name,
price
FROM
products_mst
WHERE
product_name LIKE '%マウス%' OR product_name LIKE '%キーボード%'
ORDER BY
price DESC
LIMIT 3;
```

---

##### ★select レベル 2

SELECT （条件分岐 CASE）
学習目的: CASE 文を使用して、取得したデータに条件を適用し、表示する値を動的に変更する。

問題: products_mst テーブルの全商品について、在庫数に応じて以下の在庫状況を表示してください。

在庫数が 100 個より多い場合：「在庫豊富」

在庫数が 50 個以上 100 個以下の場合：「通常在庫」

在庫数が 50 個未満の場合：「要発注」

答え:

```SQL
SELECT
product_name,
stock_quantity,
CASE
WHEN stock_quantity > 100 THEN '在庫豊富'
WHEN stock_quantity >= 50 THEN '通常在庫'
ELSE '要発注'
END AS stock_status
FROM
products_mst;
```

---

##### ★select レベル 3

問題 11：顧客ごとの購入金額集計
学習目的: GROUP BY 句を使用して、特定のカラムの値ごとにデータをグループ化して集計を行う。

問題: orders_trn と order_details_trn を結合して、各顧客がこれまでに購入した合計金額を顧客 ID ごとに集計してください。

答え:

```SQL
SELECT
T1.customer_id,
SUM(T3.price \* T2.quantity) AS total_purchase_amount
FROM
orders_trn AS T1
JOIN
order_details_trn AS T2 ON T1.order_id = T2.order_id
JOIN
products_mst AS T3 ON T2.product_id = T3.product_id
GROUP BY
T1.customer_id
ORDER BY
T1.customer_id;
```

---

##### ★select レベル 3

問題 12：最も売れている商品カテゴリの特定
学習目的: GROUP BY 句で複数のテーブルを結合し、ORDER BY 句で集計結果を並べ替える。

問題: products_mst と order_details_trn を結合して、各商品カテゴリごとの合計販売個数を計算し、販売個数が多い順に並べてください。

答え:

```SQL
SELECT
pm.category,
SUM(odt.quantity) AS total_sales_quantity
FROM
products_mst AS pm
JOIN
order_details_trn AS odt ON pm.product_id = odt.product_id
GROUP BY
pm.category
ORDER BY
total_sales_quantity DESC;
```

⇒category がテーブル定義にないから後で追加するの忘れずに！

---

##### ★update レベル 4

UPDATE （サブクエリを使った更新）

学習目的: UPDATE 文の SET 句でサブクエリを使用し、別のテーブルのデータに基づいて更新を行う。

問題: 注文されたすべての商品の在庫を、order_details_trn テーブルの販売個数分だけ products_mst テーブルから減らしてください。

答え:

```SQL
-- PostgreSQL では FROM 句にサブクエリを使用できるため、より効率的に書ける
-- 一つのトランザクションで実行することを推奨
UPDATE
products_mst AS pm
SET
stock_quantity = pm.stock_quantity - odt.total_sold_quantity
FROM
(SELECT product_id, SUM(quantity) AS total_sold_quantity
FROM order_details_trn
GROUP BY product_id) AS odt
WHERE
pm.product_id = odt.product_id;
```

---

##### ★delete レベル 4

DELETE （サブクエリを使った削除）

学習目的: DELETE 文の WHERE 句でサブクエリを使用し、別のテーブルのデータに関連する行を削除する。

問題: 過去に一度も注文されたことがない商品を products_mst テーブルから削除してください。

答え:

```SQL
DELETE FROM
products_mst
WHERE
product_id NOT IN (SELECT DISTINCT product_id FROM order_details_trn);
```
