# ステージ 1: 基礎（環境構築 & CRUD 入門）

## 1.1 データベース作成

    CREATE DATABASE
    CREATE TABLE（社員マスタ、部署マスタ など）

## 1.2 基本操作（CRUD）

    INSERT（社員登録、部署登録）
    SELECT（社員一覧の取得）
    UPDATE（役職変更）
    DELETE（退職社員削除）

- 学習ポイント
  - SQL の基本文法
  - データ型と制約（NOT NULL, PRIMARY KEY, FOREIGN KEY）
  - トランザクション（BEGIN / COMMIT / ROLLBACK）

# ステージ 2: 初級（SELECT & JOIN）

## 2.1 SELECT の基本

    列指定、WHERE 条件、ORDER BY、LIMIT

## 2.2 JOIN

    INNER JOIN（社員と部署の紐づけ）
    LEFT JOIN（退職社員も含めて表示）
    自己結合（部署ツリーの親子関係を取得）

## 2.3 集計関数

    COUNT, SUM, AVG, MIN, MAX
    GROUP BY / HAVING（部署ごとの平均給与）

- 学習ポイント
  - 実務でよく使う「社員一覧」「部署別集計」
  - JOIN を使った複数テーブルの連携

# ステージ 3: 中級（複雑な条件 & サブクエリ）

## 3.1 サブクエリ

    非相関サブクエリ（「全社員の平均給与」より高い社員を取得）
    相関サブクエリ（「部署ごとの平均給与」より高い社員）

## 3.2 集計 + 条件

    部署ごとの残業時間合計
    月ごとの勤怠状況（出勤率）

## 3.3 CASE 式

    勤怠区分ごとのカウント（出勤・休暇・遅刻を横並びに集計）

- 学習ポイント

  - サブクエリによる高度な抽出
  - CASE で実務的なレポートを作る

# ステージ 4: 上級（分析・レポート系 SQL）

## 4.1 ウィンドウ関数

    ROW_NUMBER()：社員ごとの最新給与履歴を取得
    RANK() / DENSE_RANK()：部署内での給与順位
    SUM() OVER(PARTITION BY)：部署ごとの給与累計

## 4.2 複雑な集計

    勤怠記録を元に「月別の平均出勤時刻」
    残業時間の累積ランキング

## 4.3 階層構造

    再帰 CTE を使って部署階層をツリー形式で取得

- 学習ポイント

  - 実務でレポート作成や BI ツールで必要なスキル
  - 分析系 SQL の応用力

# ステージ 5: 実務応用（運用・パフォーマンス・セキュリティ）

## 5.1 データモデリングの改善

    正規化（社員・部署・役職）
    非正規化（給与トランに冗長カラムを持たせる意義）

## 5.2 インデックスと実行計画

    インデックス作成（社員 ID, 日付, 部署 ID）
    実行計画の確認 (EXPLAIN / EXPLAIN ANALYZE)
    インデックスが効く/効かないパターン（LIKE, 関数利用など）

## 5.3 トランザクション管理

    残業申請承認処理を トランザクションで安全に更新
    ロック（悲観ロック, 楽観ロックのイメージ）

## 5.4 セキュリティ

    権限管理（人事部だけ給与テーブルを閲覧可能）
    ビューの活用（給与情報をサマリだけ公開）

- 学習ポイント
  - 実務で必須の「パフォーマンス」と「セキュリティ」
  - 運用目線での SQL の使い方

# ステージ 6: 総合演習

    部署ごとの月次レポートを作成（出勤率・残業・給与総額）
    上位 3 人の残業時間ランキングを取得
    年次昇給シミュレーションを SQL で実行
    実行計画を確認し、インデックスをチューニング

- 学習ポイント
  - CRUD から分析・チューニングまでの流れを一通り体験
  - 「現場で実際にどう使うか」を意識

```SQL
-- 社員マスタ
CREATE TABLE employee (
employee_id INT PRIMARY KEY,
employee_name VARCHAR(100) NOT NULL,
department_id INT NOT NULL,
position_id INT NOT NULL,
hire_date DATE NOT NULL,
resign_date DATE, -- 退職済みなら設定
CONSTRAINT fk_emp_dept FOREIGN KEY (department_id) REFERENCES department(department_id),
CONSTRAINT fk_emp_pos FOREIGN KEY (position_id) REFERENCES position(position_id)
);

-- 部署マスタ
CREATE TABLE department (
department_id INT PRIMARY KEY,
department_name VARCHAR(100) NOT NULL,
parent_department_id INT NULL,
CONSTRAINT fk_dept_parent FOREIGN KEY (parent_department_id) REFERENCES department(department_id)
);

-- 役職マスタ
CREATE TABLE position (
position_id INT PRIMARY KEY,
position_name VARCHAR(100) NOT NULL,
base_salary DECIMAL(10,2) NOT NULL, -- 基本給
coefficient DECIMAL(5,2) NOT NULL -- 役職係数
);

-- 勤怠区分マスタ
CREATE TABLE attendance_type (
attendance_type_id INT PRIMARY KEY,
type_name VARCHAR(50) NOT NULL -- 出勤, 欠勤, 遅刻, 休暇 etc
);

-- 勤怠記録
CREATE TABLE attendance_record (
attendance_id INT PRIMARY KEY,
employee_id INT NOT NULL,
work_date DATE NOT NULL,
start_time TIME,
end_time TIME,
attendance_type_id INT NOT NULL,
CONSTRAINT fk_att_emp FOREIGN KEY (employee_id) REFERENCES employee(employee_id),
CONSTRAINT fk_att_type FOREIGN KEY (attendance_type_id) REFERENCES attendance_type(attendance_type_id)
);

-- 残業申請
CREATE TABLE overtime_request (
request_id INT PRIMARY KEY,
employee_id INT NOT NULL,
request_date DATE NOT NULL,
overtime_hours DECIMAL(5,2) NOT NULL,
approver_id INT,
status VARCHAR(20) NOT NULL, -- pending, approved, rejected
CONSTRAINT fk_req_emp FOREIGN KEY (employee_id) REFERENCES employee(employee_id),
CONSTRAINT fk_req_approver FOREIGN KEY (approver_id) REFERENCES employee(employee_id)
);

-- 給与トラン
CREATE TABLE payroll (
payroll_id INT PRIMARY KEY,
employee_id INT NOT NULL,
year_month CHAR(7) NOT NULL, -- 例: "2025-08"
base_salary DECIMAL(10,2) NOT NULL,
overtime_pay DECIMAL(10,2),
deduction DECIMAL(10,2),
total_pay DECIMAL(10,2),
CONSTRAINT fk_pay_emp FOREIGN KEY (employee_id) REFERENCES employee(employee_id)
);
```
