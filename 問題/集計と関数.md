# EC サイトデータ 集計・関数問題集

## 集計とグループ化に関する問題

### 問題 1: 全商品数とカテゴリ数

### 重要度: ★★★★

### 問題目的: COUNT(\*)と COUNT(DISTINCT 列名)を使用して、テーブルの全行数と重複を除いた要素数をカウントする方法を理解する。

### 問題:

products_mst テーブルに登録されている全商品数をカウントしてください。
products_mst テーブルに登録されているユニークなカテゴリ数をカウントしてください。

### 答え:

```SQL
-- 全商品数
SELECT
	COUNT(*) AS TOTAL_PRODUCTS
FROM
	PRODUCTS_MST;
-- ユニークなカテゴリ数
SELECT
	COUNT(DISTINCT CATEGORY) AS UNIQUE_CATEGORIES
FROM
	PRODUCTS_MST;
```

### 問題 2: 商品の合計価格と平均価格

### 重要度: ★★★★

### 問題目的: SUM()と AVG()を使用して、数値列の合計値と平均値を算出する方法を理解する。

### 問題: products_mst テーブルに登録されている全商品の価格の合計と平均価格をそれぞれ算出してください。

### 答え:

```SQL
SELECT
	SUM(PRICE) AS TOTAL_PRICE,
	AVG(PRICE) AS AVERAGE_PRICE
FROM
	PRODUCTS_MST;
```

### 問題 3: 最も安い商品と最も高い商品の価格

### 重要度: ★★★★

### 問題目的: MIN()と MAX()を使用して、列の最小値と最大値を特定する方法を理解する。

### 問題: products_mst テーブルから、最も安い商品の価格と最も高い商品の価格をそれぞれ取得してください。

### 答え:

```SQL
SELECT
	MIN(PRICE) AS MIN_PRODUCT_PRICE,
	MAX(PRICE) AS MAX_PRODUCT_PRICE
FROM
	PRODUCTS_MST;
```

### 問題 4: カテゴリごとの商品数と平均価格

### 重要度: ★★★★★

### 問題目的: GROUP BY 句を使用して、特定の列（カテゴリ）でデータをグループ化し、グループごとに集計関数を実行する方法を理解する。

### 問題: products_mst テーブルから、カテゴリごとに商品数と平均価格を算出してください。

### 答え:

```SQL
SELECT
	CATEGORY,
	COUNT(*) AS PRODUCT_COUNT,
	AVG(PRICE) AS AVERAGE_PRICE
FROM
	PRODUCTS_MST
GROUP BY
	CATEGORY;
```

備考：ROUND(AVG(price), 2) AS avg_price や、CAST(AVG(price) AS NUMERIC(10,2)) AS avg_price などして、キャストしてもいいかもね。AVG は numeric 型だが、スケールは無制限で返すため。

### 問題 5: 高価格帯の商品が多いカテゴリを特定する

### 重要度: ★★★★★

### 問題目的: HAVING 句を使用して、GROUP BY で集計された結果に対して条件を指定し、フィルタリングする方法を理解する。

### 問題: products_mst テーブルから、平均価格が 5000 円より大きいカテゴリを抽出し、そのカテゴリ名、商品数、平均価格を表示してください。

### 答え:

```SQL
SELECT
	CATEGORY,
	COUNT(*) AS PRODUCT_COUNT,
	AVG(PRICE) AS AVERAGE_PRICE
FROM
	PRODUCTS_MST
GROUP BY
	CATEGORY
HAVING
	AVG(PRICE) > 5000;
```

### 問題 6: 在庫が特定の数量以上の商品のカテゴリ別集計

### 重要度: ★★★★★

### 問題目的: WHERE 句で集計前の行フィルタリングを行い、その後に GROUP BY と HAVING を組み合わせて集計後のグループをフィルタリングする処理順序を理解する。

### 問題: products_mst テーブルから、在庫数(stock_quantity)が 100 個以上の商品のみを対象に、カテゴリごとの商品数を算出してください。ただし、商品数が 2 つ以上のカテゴリのみを表示してください。

### 答え:

```SQL
SELECT
	CATEGORY,
	COUNT(*) AS PRODUCT_COUNT
FROM
	PRODUCTS_MST
WHERE
	STOCK_QUANTITY >= 100 -- まず、在庫数 100 個以上の商品に絞り込む
GROUP BY
	CATEGORY
HAVING
	COUNT(*) >= 2;
-- その後、グループ化された結果で商品数が 2 つ以上のものを抽出
```

関数に関する問題

### 問題 7: 顧客名とメールアドレスを結合して表示する

### 重要度: ★★★★

### 問題目的: CONCAT()関数または||演算子を使用して、複数の文字列を結合する方法を理解する。

### 問題: customers_mst テーブルから、顧客の名前とメールアドレスを CONCAT 関数（または||演算子）で結合し、「顧客名 (メールアドレス)」の形式で表示してください。エイリアスは customer_contact としてください。

### 答え:

```SQL
SELECT
	CONCAT(CUSTOMER_NAME, ' (', EMAIL, ')') AS CUSTOMER_CONTACT
FROM
	CUSTOMERS_MST;
```

### バリエーション (PostgreSQL の||演算子):

```SQL
SELECT
	CUSTOMER_NAME || ' (' || EMAIL || ')' AS CUSTOMER_CONTACT
FROM
	CUSTOMERS_MST;
```

### 問題 8: 商品名の短縮形と大文字・小文字変換

### 重要度: ★★★★

### 問題目的: SUBSTRING(), UPPER(), LOWER()関数を使用して文字列を加工する方法を理解する。

### 問題: products_mst テーブルから、以下の形式で商品名を表示してください。

商品名の最初の 3 文字を抽出して表示する (short_name として)。
商品名を全て大文字に変換して表示する (upper_name として)。
商品名を全て小文字に変換して表示する (lower_name として)。

### 答え:

```SQL
SELECT
	PRODUCT_NAME,
	SUBSTRING(
		PRODUCT_NAME
		FROM
			1 FOR 3
	) AS SHORT_NAME,
	UPPER(PRODUCT_NAME) AS UPPER_NAME,
	LOWER(PRODUCT_NAME) AS LOWER_NAME
FROM
	PRODUCTS_MST;
```

⇒ ぶっちゃけ SHORT_NAME にする意味はないが、勉強と思って、、、

### 問題 9: 商品メモの空白を除去する

### 重要度: ★★★★

### 問題目的: TRIM()関数を使用して、文字列の両端の空白文字を除去する方法を理解する。

### 問題: products_mst テーブルの memo 列に、もし余分な空白が含まれている場合を想定し、その空白を両端から除去したメモの内容を表示してください。元のメモとトリム後のメモの両方を表示し、メモが NULL ではないもののみを対象とします。

### 答え:

```SQL
SELECT
	PRODUCT_NAME,
	MEMO AS ORIGINAL_MEMO,
	TRIM(MEMO) AS TRIMMED_MEMO
FROM
	PRODUCTS_MST
WHERE
	MEMO IS NOT NULL;
```

### 問題 10: 現在の日付と時刻を取得し、特定の形式で表示する

### 重要度: ★★★★

### 問題目的: NOW()または CURRENT_TIMESTAMP で現在日時を取得し、TO_CHAR()で日付を整形する方法を理解する。

### 問題:

現在のシステム日時を取得してください。
現在のシステム日時を「YYYY 年 MM 月 DD 日 HH 時 MI 分 SS 秒」の形式で表示してください。

### 答え:

```SQL
-- 現在のシステム日時
SELECT
	NOW() AS CURRENT_DATETIME;

-- 整形された現在日時
SELECT
	TO_CHAR(NOW(), 'YYYY 年 MM 月 DD 日 HH24 時 MI 分 SS 秒') AS FORMATTED_DATETIME;
```

### 問題 11: 注文日の翌週の同じ曜日を計算する

### 重要度: ★★★★★

### 問題目的: INTERVAL キーワードを使用して日付に期間を加算する方法を理解する。

### 問題: orders_trn テーブルから、各注文の注文日と、その注文日の**7 日後（翌週の同じ曜日）**の日付を計算して表示してください。

### 答え:

```SQL
SELECT
	ORDER_ID,
	ORDER_DATE,
	ORDER_DATE + INTERVAL '7 day' AS NEXT_WEEK_DATE
FROM
	ORDERS_TRN;
```

### 問題 12: 顧客の登録月を抽出する

### 重要度: ★★

### 問題目的: EXTRACT()関数を使用して日付から特定の部分（月）を抽出する方法を理解する。

### 問題: customers_mst テーブルから、各顧客の登録日（created_date）の月を数値で抽出して表示してください。

### 答え:

```SQL
SELECT
	CUSTOMER_NAME,
	CREATED_DATE,
	EXTRACT(
		MONTH
		FROM
			CREATED_DATE
	) AS REGISTRATION_MONTH
FROM
	CUSTOMERS_MST;
```

### 問題 13: 注文日の曜日名を表示する

### 重要度: ★★★★★

### 問題目的: TO_CHAR()関数を使用して日付から曜日名を抽出する方法を理解する。

### 問題: orders_trn テーブルから、各注文の注文日と、その注文日が何曜日かを日本語のフルネーム（例: '月曜日', '火曜日'）で表示してください。

### 答え:

```SQL
SELECT
	ORDER_ID,
	ORDER_DATE,
	TO_CHAR(ORDER_DATE, 'Day') AS ORDER_DAY_OF_WEEK -- PostgreSQL では'Day'が曜日名を返す
FROM
	ORDERS_TRN;
```

⇒ これ英語だね。というかあまりいい問題じゃない

### 補足: PostgreSQL の TO_CHAR 関数は、環境のロケール設定によっては英語の曜日名（e.g., 'Monday')を返す場合があります。日本語の曜日名を得るには LC_TIME 設定などが必要になることがありますが、基本的な使い方として'Day'を指定します。

### 問題 14: 注文ごとの異なる商品点数と合計購入個数

### 重要度: ★★★★★

### 問題目的: COUNT(DISTINCT 列名)と SUM()を組み合わせて、各グループ内でユニークな要素の数と合計を算出する方法を理解する。

### 問題: order_details_trn テーブルから、注文 ID(order_id)ごとに異なる商品の種類数（商品点数）と、その注文における合計購入個数(quantity)を算出してください。

### 答え:

```SQL
SELECT
	ORDER_ID,
	COUNT(DISTINCT PRODUCT_ID) AS DISTINCT_PRODUCT_COUNT,
	SUM(QUANTITY) AS TOTAL_QUANTITY_ORDERED
FROM
	ORDER_DETAILS_TRN
GROUP BY
	ORDER_ID;
```

⇒ これを出して何をするかが想像しにくいので良問ではないかも、、、

### 問題 15: 顧客の登録年ごとの顧客数

### 重要度: ★★★★

### 問題目的: EXTRACT()関数で日付から月を抽出し、その年でグループ化して集計を行う方法を理解する。

### 問題: customers_mst テーブルから、顧客の登録月(created_date)ごとに登録された顧客の数を算出してください。

### 答え:

```SQL
SELECT
	EXTRACT(
		MONTH
		FROM
			CREATED_DATE
	) AS REGISTRATION_MONTH,
	COUNT(*) AS CUSTOMER_COUNT
FROM
	CUSTOMERS_MST
GROUP BY
	REGISTRATION_MONTH
ORDER BY
	REGISTRATION_MONTH;
```

### 問題 16: 平均価格が高く、かつ特定の高価格帯の商品を含むカテゴリの抽出

### 重要度: ★★★★★

### 問題目的: WHERE 句と HAVING 句をより複雑に組み合わせ、集計前と集計後の両方で条件を適用する。

### 問題: products_mst テーブルから、価格が 10000 円より高い商品が少なくとも 1 つ含まれるカテゴリで、かつそのカテゴリの平均価格が 15000 円より大きいものを抽出し、カテゴリ名、商品数、平均価格を表示してください。

### 答え:

```SQL
SELECT
	CATEGORY,
	COUNT(*) AS PRODUCT_COUNT,
	AVG(PRICE) AS AVERAGE_PRICE
FROM
	PRODUCTS_MST
WHERE
	PRODUCT_ID IN (
		SELECT
			PRODUCT_ID
		FROM
			PRODUCTS_MST
		WHERE
			PRICE > 10000
	) -- 価格が 10000 円より高い商品が含まれるカテゴリを対象とする（集計前のフィルタリング）
GROUP BY
	CATEGORY
HAVING
	AVG(PRICE) > 15000;

-- 集計後の平均価格でフィルタリング
```

⇒ これサブクエリ使ってましたね、、、削除かな

### 補足: この問題はサブクエリを使用していますが、集計とグループ化の理解を深めるために重要です。WHERE 句で先に特定の条件を満たす行を絞り込むことで、GROUP BY と HAVING の処理が効率化されることを示唆しています。

---

# 単一関数の問題

### 問題 17: 顧客メールアドレスのドメイン名抽出

### 重要度: ★★★★★

### 問題目的: 文字列関数を組み合わせて、特定のパターン（この場合は@より後ろ）を抽出する方法を理解する。

### 問題: customers_mst テーブルから、各顧客のメールアドレスからドメイン名のみを抽出して表示してください。（例: sato.taro@example.com から example.com を抽出）

### 答え:

```SQL
SELECT
	CUSTOMER_NAME,
	EMAIL,
	SUBSTRING(
		EMAIL
		FROM
			POSITION('@' IN EMAIL) + 1
	) AS EMAIL_DOMAIN
FROM
	CUSTOMERS_MST;
```

### バリエーション (PostgreSQL の SPLIT_PART 関数):

```SQL
SELECT
	CUSTOMER_NAME,
	EMAIL,
	SPLIT_PART(EMAIL, '@', 2) AS EMAIL_DOMAIN
FROM
	CUSTOMERS_MST;
```

### 問題 18: 注文から 90 日後の日付を計算し、月別で集計

### 重要度: ★★★★★

### 問題目的: 日付の加算と EXTRACT()関数、GROUP BY を組み合わせ、計算後の日付で集計する方法を理解する。

### 問題: orders_trn テーブルから、各注文の注文日から 90 日後の日付を計算してください。その上で、その「90 日後の日付」の月ごとに、該当する注文の数を算出してください。

### 答え:

```SQL
SELECT
	EXTRACT(
		MONTH
		FROM
			(ORDER_DATE + INTERVAL '90 day')
	) AS CALCULATED_MONTH,
	COUNT(*) AS ORDERS_COUNT
FROM
	ORDERS_TRN
GROUP BY
	CALCULATED_MONTH
ORDER BY
	CALCULATED_MONTH;
```

⇒ これは何がしたいのか想像しにくいので良問ではないかも

### 問題 19: 商品名の文字長を取得する

### 重要度: ★★★★

### 問題目的: LENGTH()または CHAR_LENGTH()関数を使用して、文字列の長さを取得する方法を理解する。

### 問題: products_mst テーブルから、商品名とその文字長を両方表示してください。

### 答え:

```SQL
SELECT
	PRODUCT_NAME,
	LENGTH(PRODUCT_NAME) AS PRODUCT_NAME_LENGTH -- 文字列のバイト長を返す場合がある (ASCII 文字以外は注意)
	-- CHAR_LENGTH(product_name) AS product_name_char_length -- 文字数を返す (PostgreSQL 推奨)
FROM
	PRODUCTS_MST;
```

⇒ この問題は微妙

### 補足: LENGTH()は多くの場合バイト長を返しますが、PostgreSQL では文字数を返します。より確実に文字数を取得するには CHAR_LENGTH()（または CHARACTER_LENGTH()）が推奨されます。

### 問題 20: NULL のメモを「メモなし」と表示する

### 重要度: ★★★★★

### 問題目的: COALESCE()関数を使用して、NULL 値が返される可能性のある式や列に対して、代替の非 NULL 値を指定する方法を理解する。

### 問題: products_mst テーブルから、商品名とメモを表示してください。ただし、メモ(memo)が NULL の場合は、'メモなし'という文字列を代わりに表示してください。

### 答え:

```SQL
SELECT
	PRODUCT_NAME,
	COALESCE(MEMO, 'メモなし') AS DISPLAY_MEMO
FROM
	PRODUCTS_MST;
```

### 補足: COALESCE 関数は引数を左から順に評価し、最初に NULL ではない値を返します。これにより、NULL 値をユーザーにとって分かりやすい代替値に変換できます。
